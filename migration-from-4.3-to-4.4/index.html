<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Guide: Electronic Invoicing v4.3 to v4.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Favicon Link -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Color Palette from style.dart */
        :root {
            --primary-color: #5EB0C7;
            --brand-blue: #005973;
            --brand-green: #00A791;
            
            /* Light Theme */
            --bg-light: #F5F5F5;
            --text-light: #6F6F6F;
            --text-heading-light: #005973;
            --section-bg-light: #FFFFFF;
            --border-light: #e2e8f0;
            --sidebar-bg-light: #FFFFFF;
            --sidebar-text-light: #6F6F6F;
            --sidebar-hover-light: var(--primary-color);
            --sticky-header-bg-light: #FFFFFF;

            /* Dark Theme */
            --bg-dark: #414141;
            --text-dark: #E8E8E8;
            --text-heading-dark: #E8E8E8;
            --section-bg-dark: #6F6F6F;
            --border-dark: #5a5a5a;
            --sidebar-bg-dark: #4a4a4a;
            --sidebar-text-dark: #E8E8E8;
            --sidebar-hover-dark: var(--primary-color);
            --sticky-header-bg-dark: #5a5a5a;
        }

        .dark {
            --bg-light: var(--bg-dark);
            --text-light: var(--text-dark);
            --text-heading-light: var(--text-heading-dark);
            --section-bg-light: var(--section-bg-dark);
            --border-light: var(--border-dark);
            --sidebar-bg-light: var(--sidebar-bg-dark);
            --sidebar-text-light: var(--sidebar-text-dark);
            --sidebar-hover-light: var(--sidebar-hover-dark);
            --sticky-header-bg-light: var(--sticky-header-bg-dark);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .content-section {
            border-left: 3px solid transparent;
            padding-left: 1.5rem;
            transition: all 0.3s ease;
        }
        .content-section:target {
           border-left-color: var(--primary-color);
           background-color: var(--section-bg-light);
           box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
           border-radius: 0.5rem;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            vertical-align: top;
            text-align: left;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: var(--sticky-header-bg-light);
            color: var(--text-heading-light);
        }
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .tag-new { background-color: #dcfce7; color: #166534; }
        .tag-modified { background-color: #ffedd5; color: #9a3412; }
        .tag-removed { background-color: #fee2e2; color: #991b1b; }
        .tag-info { background-color: #e0e7ff; color: #3730a3; }
        
        /* Theming classes */
        .bg-main { background-color: var(--bg-light); }
        .text-main { color: var(--text-light); }
        .text-heading { color: var(--text-heading-light); }
        .bg-section { background-color: var(--section-bg-light); }
        .border-main { border-color: var(--border-light); }
        .bg-sidebar { background-color: var(--sidebar-bg-light); }
        .text-sidebar { color: var(--sidebar-text-light); }
        .hover-sidebar-text:hover { color: var(--sidebar-hover-light); }
        .divide-main > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-light); }
    </style>
</head>
<body class="bg-main text-main">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="mb-12">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <div id="theme-switcher" class="flex items-center p-1 bg-section border border-main rounded-full">
                    <button data-theme="light" class="p-2 rounded-full focus:outline-none">
                        <i data-lucide="sun" class="w-5 h-5"></i>
                    </button>
                    <button data-theme="dark" class="p-2 rounded-full focus:outline-none">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <button data-theme="system" class="p-2 rounded-full focus:outline-none">
                        <i data-lucide="laptop" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold text-heading">Electronic Invoicing Migration Guide</h1>
                <p class="text-2xl mt-2" style="color: var(--primary-color);">Version 4.3 to 4.4</p>
                <p class="mt-4 text-main max-w-3xl mx-auto">A comprehensive guide for the development team to upgrade the full-stack application (Flutter, Node.js/TypeScript, Firebase) to comply with the latest electronic invoicing regulations.</p>
            </div>
        </header>

        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar Navigation -->
            <aside class="md:w-1/4 lg:w-1/5 md:sticky top-8 self-start">
                <nav class="bg-sidebar p-4 rounded-lg shadow-sm border border-main">
                    <h3 class="font-bold text-lg mb-4 text-heading">Contents</h3>
                    <ul class="space-y-2">
                        <li><a href="#overview" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="alert-circle" class="w-4 h-4"></i>Overview & Timeline</a></li>
                        <li><a href="#setup" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="settings-2" class="w-4 h-4"></i>Project Setup</a></li>
                        <li><a href="#header" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="file-text" class="w-4 h-4"></i>Header Changes</a></li>
                        <li><a href="#line-items" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="list" class="w-4 h-4"></i>Line Item Changes</a></li>
                        <li><a href="#summary" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="sigma" class="w-4 h-4"></i>Summary Changes</a></li>
                        <li><a href="#reference" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="link" class="w-4 h-4"></i>Reference Info</a></li>
                        <li><a href="#security" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="shield-check" class="w-4 h-4"></i>Security & Signature</a></li>
                        <li><a href="#code-examples" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="code" class="w-4 h-4"></i>Code Examples</a></li>
                        <li><a href="#team-tasks" class="flex items-center gap-2 text-sidebar hover-sidebar-text font-medium"><i data-lucide="users" class="w-4 h-4"></i>Team Tasks</a></li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="md:w-3/4 lg:w-4/5">
                <div class="space-y-16">

                    <!-- Overview Section -->
                    <section id="overview" class="content-section">
                        <h2 class="text-3xl font-bold mb-4 text-heading">Overview & Timeline</h2>
                        <div class="border-l-4 p-6 rounded-r-lg shadow-sm" style="border-color: var(--primary-color); background-color: color-mix(in srgb, var(--primary-color) 15%, transparent);">
                            <h4 class="font-bold text-xl mb-2 flex items-center gap-2 text-heading"><i data-lucide="calendar-clock" class="w-6 h-6"></i>Effective Date: June 1, 2025</h4>
                            <p>All new electronic invoices must conform to the v4.4 structure starting on this date. Version 4.3 will only be valid for generating credit and debit notes that adjust documents originally issued under v4.3.</p>
                        </div>
                        <p class="mt-6 text-lg">This migration involves significant changes across the entire stack. The goal is to update our system to be fully compliant with the new regulations, ensuring seamless operation for our users. This guide details every new, modified, and removed field, providing specific implementation guidance for both the backend and frontend.</p>
                    </section>

                    <!-- Project Setup Section -->
                    <section id="setup" class="content-section">
                        <h2 class="text-3xl font-bold mb-4 text-heading">General Changes & Project Setup</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-section p-6 rounded-lg shadow-sm border border-main">
                                <h3 class="font-bold text-xl mb-3 flex items-center gap-2 text-heading"><i data-lucide="server" class="w-5 h-5" style="color: var(--brand-blue)"></i>Backend (Node.js/TypeScript)</h3>
                                <ul class="list-disc list-inside space-y-2">
                                    <li><strong>Update Data Models:</strong> Create new TypeScript interfaces for v4.4 (e.g., `InvoiceV44`). Retain v4.3 interfaces for backward compatibility.</li>
                                    <li><strong>Versioning Logic:</strong> Implement a versioning strategy. Use an environment variable or a configuration flag to switch between generating v4.3 and v4.4 XMLs.</li>
                                    <li><strong>Firebase Schema:</strong> Update Firestore documents to include a `version: '4.4'` field. Plan a migration script for existing data if necessary.</li>
                                    <li><strong>Cloud Functions:</strong> Refactor all Cloud Functions related to invoice creation, processing, and validation to handle the new v4.4 structure and logic.</li>
                                </ul>
                            </div>
                            <div class="bg-section p-6 rounded-lg shadow-sm border border-main">
                                <h3 class="font-bold text-xl mb-3 flex items-center gap-2 text-heading"><i data-lucide="smartphone" class="w-5 h-5" style="color: var(--primary-color)"></i>Frontend (Flutter)</h3>
                                <ul class="list-disc list-inside space-y-2">
                                    <li><strong>Update Data Models:</strong> Create new Dart models to mirror the backend's v4.4 interfaces.</li>
                                    <li><strong>UI/UX Enhancements:</strong> Design and implement new UI components for the added fields. Ensure forms are intuitive and handle conditional logic gracefully.</li>
                                    <li><strong>State Management:</strong> Update your state management layer (BLoC/Riverpod/Provider) to manage the state of new fields, validation rules, and conditional UI visibility.</li>
                                    <li><strong>User Guidance:</strong> Add tooltips or info icons to explain new fields to the user, such as the "Transaction Type" or the new ID types.</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- Header Changes Section -->
                    <section id="header" class="content-section">
                        <h2 class="text-3xl font-bold mb-6 text-heading">Header ("Encabezado") Changes</h2>
                        <div class="overflow-x-auto bg-section rounded-lg shadow-sm border border-main">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-4 font-semibold">Field</th>
                                        <th class="p-4 font-semibold">Change</th>
                                        <th class="p-4 font-semibold">Details & Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-main">
                                    <tr>
                                        <td class="p-4 font-semibold">ProveedorSistemas</td>
                                        <td class="p-4"><span class="tag tag-new">New</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Identifies the invoicing system provider.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Backend:</strong> Add `proveedorSistemas` (String, 20) to the main invoice model. Validate it's a correct ID.</li>
                                                <li><strong>Frontend:</strong> Add a new field in the company settings page. This can be pre-filled from config.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">CodigoActividadReceptor</td>
                                        <td class="p-4"><span class="tag tag-new">New</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Recipient's economic activity code.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Backend:</strong> Add `codigoActividadReceptor` (String, 6) to the Receptor model. Initially conditional.</li>
                                                <li><strong>Frontend:</strong> Add a new text field in the recipient details form.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">TipoIdentificacion</td>
                                        <td class="p-4"><span class="tag tag-modified">Modified</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">New ID types added.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>Adds `05: Extranjero No Domiciliado` and `06: No Contribuyente`.</li>
                                                <li><strong>Backend:</strong> Update ID type enums and validation logic for their specific use cases (e.g., `05` is only for `Factura de Compra` emitter).</li>
                                                <li><strong>Frontend:</strong> Update the ID Type dropdown menu with the new options.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">Numero (ID)</td>
                                        <td class="p-4"><span class="tag tag-modified">Modified</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Field length increased for new ID types.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>Size increased to **20 characters** for ID types `05` and `06`.</li>
                                                <li><strong>Backend/Frontend:</strong> Update validation and input field max length.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                     <tr>
                                        <td class="p-4 font-semibold">Fax</td>
                                        <td class="p-4"><span class="tag tag-removed">Removed</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">The Fax node for both emitter and recipient has been removed.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Backend:</strong> Remove the `fax` property from Emisor and Receptor models.</li>
                                                <li><strong>Frontend:</strong> Remove the Fax input fields from the UI.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Line Items Section -->
                    <section id="line-items" class="content-section">
                        <h2 class="text-3xl font-bold mb-6 text-heading">Line Item ("Detalle") Changes</h2>
                        <div class="overflow-x-auto bg-section rounded-lg shadow-sm border border-main">
                             <table class="w-full text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-4 font-semibold">Field / Node</th>
                                        <th class="p-4 font-semibold">Change</th>
                                        <th class="p-4 font-semibold">Details & Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-main">
                                    <tr>
                                        <td class="p-4 font-semibold">DetalleSurtido</td>
                                        <td class="p-4"><span class="tag tag-new">New</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">A new node to detail the components of a bundled product (combo/package).</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Backend:</strong> This is a major structural change. Create models for `DetalleSurtido` and `LineaDetalleSurtido`. The main line item's totals must be calculated from the sum of its components.</li>
                                                <li><strong>Frontend:</strong> Implement a sub-form or modal that appears when a user selects a "combo" CAByS code, allowing them to add and detail the individual products within the bundle.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">Descuento</td>
                                        <td class="p-4"><span class="tag tag-modified">Modified</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Discount identification is now mandatory.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>New mandatory field `CodigoDescuento` (String, 2) to specify the discount type (from Note 20).</li>
                                                <li>New conditional field `CodigoDescuentoOTRO` if code `99` is used.</li>
                                                <li><strong>Backend:</strong> Add fields to the Discount model and update validation.</li>
                                                <li><strong>Frontend:</strong> Add a dropdown for "Discount Type" next to the discount amount field.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">Impuesto</td>
                                        <td class="p-4"><span class="tag tag-modified">Modified</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Significant changes to tax calculation and structure.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>`BaseImponible` is now mandatory for taxed items.</li>
                                                <li>New `IVAcobradoFabrica` field for special tax cases.</li>
                                                <li>New `DatosImpuestoEspecifico` node for non-tariff based taxes.</li>
                                                <li><strong>Backend:</strong> This requires a thorough review of all tax calculation logic. Update the Impuesto model with new fields and nodes.</li>
                                                <li><strong>Frontend:</strong> The tax section of the line item form may need to be redesigned for clarity and to accommodate the new fields and logic.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <!-- Summary Section -->
                    <section id="summary" class="content-section">
                        <h2 class="text-3xl font-bold mb-6 text-heading">Summary ("Resumen") Changes</h2>
                        <div class="overflow-x-auto bg-section rounded-lg shadow-sm border border-main">
                             <table class="w-full text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-4 font-semibold">Field / Node</th>
                                        <th class="p-4 font-semibold">Change</th>
                                        <th class="p-4 font-semibold">Details & Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-main">
                                    <tr>
                                        <td class="p-4 font-semibold">MedioDePago</td>
                                        <td class="p-4"><span class="tag tag-modified">Modified</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">Node moved from Line Item to Summary. New payment methods added.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>New codes: `06: SINPE MOVIL`, `07: Plataforma Digital`.</li>
                                                <li><strong>Backend:</strong> Relocate the `MedioDePago` model from the main structure to within the `ResumenFactura` model. Update enums.</li>
                                                <li><strong>Frontend:</strong> Ensure payment method selection is part of the final summary section. Update the payment method dropdown.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-semibold">New Total Fields</td>
                                        <td class="p-4"><span class="tag tag-new">New</span></td>
                                        <td class="p-4">
                                            <p class="font-medium">New fields for more granular totals.</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>`TotalServNoSujetos`</li>
                                                <li>`TotalMercNoSujetas`</li>
                                                <li>`TotalNoSujeto`</li>
                                                <li>`TotalDesgloselmpuesto` (new node for breakdown by tax type)</li>
                                                <li><strong>Backend:</strong> Add these fields to the `ResumenFactura` model and implement the corresponding calculation logic.</li>
                                                <li><strong>Frontend:</strong> Display these new totals in the invoice summary view.</li>
                                            </ul>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Reference Info Section -->
                    <section id="reference" class="content-section">
                        <h2 class="text-3xl font-bold mb-4 text-heading">Reference Information Changes</h2>
                        <p class="mb-4">The `InformacionReferencia` section has been updated with new codes to handle more scenarios.</p>
                        <div class="bg-section p-6 rounded-lg shadow-sm border border-main">
                            <h3 class="font-bold text-xl mb-3 text-heading">New Reference Codes (Note 9)</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li><span class="font-mono bg-main px-2 py-1 rounded">06:</span> Devolución de mercancía (Merchandise return)</li>
                                <li><span class="font-mono bg-main px-2 py-1 rounded">07:</span> Sustituye Comprobante electrónico (Substitutes electronic document)</li>
                                <li><span class="font-mono bg-main px-2 py-1 rounded">08:</span> Factura Endosada (Endorsed invoice)</li>
                                <li><span class="font-mono bg-main px-2 py-1 rounded">11:</span> Proveedor No Domiciliado (Non-domiciled provider)</li>
                            </ul>
                            <p class="mt-4"><strong>Action:</strong> Update enums/constants for these codes in both backend and frontend applications.</p>
                        </div>
                    </section>

                    <!-- Security Section -->
                    <section id="security" class="content-section">
                        <h2 class="text-3xl font-bold mb-4 text-heading">Security & Signature Changes</h2>
                        <div class="bg-section p-6 rounded-lg shadow-sm border border-main">
                            <h3 class="font-bold text-xl mb-3 text-heading">Enhanced Signature Capabilities</h3>
                            <p>The `ds:Signature` node now officially supports multiple signatures for different roles using the `<xades:ClaimedRole>` attribute. This is crucial for commercial processes like credit acceptance and invoice endorsement.</p>
                            <ul class="list-disc list-inside space-y-2 mt-4">
                                <li><strong>Receptor Signature:</strong> A recipient can now counter-sign a credit invoice by adding a signature with `<xades:ClaimedRole>Receptor</xades:ClaimedRole>`.</li>
                                <li><strong>Endorsement:</strong> For invoice endorsement, sequential signatures can be added with roles like `<xades:ClaimedRole>Endosante1</xades:ClaimedRole>` and `<xades:ClaimedRole>Endosatario1</xades:ClaimedRole>`.</li>
                            </ul>
                            <div class="mt-4 border-l-4 p-4 rounded-r-lg" style="border-color: var(--brand-blue); background-color: color-mix(in srgb, var(--brand-blue) 10%, transparent);">
                                <p><strong class="text-heading">Important:</strong> Counter-signed documents are for commercial purposes only and should <strong class="text-heading">not</strong> be re-submitted to the tax authority. The initially validated XML is the only one valid for tax purposes.</p>
                            </div>
                            <p class="mt-4"><strong>Action:</strong> If your application needs to support these features, the backend's XML signing library must be updated to handle the injection of these specific XAdES attributes.</p>
                        </div>
                    </section>

                    <!-- Code Examples Section -->
                    <section id="code-examples" class="content-section">
                        <h2 class="text-3xl font-bold mb-4 text-heading">Code Implementation Examples</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-heading">Backend: TypeScript Interface (v4.4)</h3>
                                <pre class="p-4 rounded-lg text-xs overflow-x-auto" style="background-color: #255B6A; color: #E8E8E8;"><code class="language-typescript">
export interface InvoiceV44 {
  clave: string;
  proveedorSistemas: string; // New
  numeroConsecutivo: string;
  // ... other header fields
  emisor: EmisorV44;
  receptor: ReceptorV44;
  detalleServicio: LineaDetalleV44[];
  resumenFactura: ResumenFacturaV44;
}

export interface LineaDetalleV44 {
  numeroLinea: number;
  codigoCABYS: string;
  tipoTransaccion?: string; // New
  numeroVINoSerie?: string; // New
  // ...
  descuentos?: DescuentoV44[];
  impuestos?: ImpuestoV44[];
  detalleSurtido?: DetalleSurtidoV44[]; // New
}

export interface DescuentoV44 {
    montoDescuento: number;
    naturalezaDescuento: string;
    codigoDescuento: string; // New
}

export interface ResumenFacturaV44 {
    // ...
    totalServNoSujetos: number; // New
    totalMercNoSujetas: number; // New
    medioPago: MedioPagoV44[]; // Moved here
}
                                </code></pre>
                            </div>
                             <div>
                                <h3 class="font-semibold text-lg mb-2 text-heading">Frontend: Flutter Model (v4.4)</h3>
                                <pre class="p-4 rounded-lg text-xs overflow-x-auto" style="background-color: #255B6A; color: #E8E8E8;"><code class="language-dart">
class InvoiceV44 {
  final String clave;
  final String proveedorSistemas; // New
  final String numeroConsecutivo;
  // ... other header fields
  final EmisorV44 emisor;
  final ReceptorV44 receptor;
  final List<LineaDetalleV44> detalleServicio;
  final ResumenFacturaV44 resumenFactura;

  InvoiceV44({ required this.clave, required this.proveedorSistemas, ... });
}

class LineaDetalleV44 {
  final int numeroLinea;
  final String codigoCABYS;
  final String? tipoTransaccion; // New
  final String? numeroVINoSerie; // New
  // ...
  final List<DescuentoV44>? descuentos;
  final List<ImpuestoV44>? impuestos;
  final List<DetalleSurtidoV44>? detalleSurtido; // New
}

class DescuentoV44 {
  final double montoDescuento;
  final String naturalezaDescuento;
  final String codigoDescuento; // New
}

class ResumenFacturaV44 {
  // ...
  final double totalServNoSujetos; // New
  final double totalMercNoSujetas; // New
  final List<MedioPagoV44> medioPago; // Moved here
}
                                </code></pre>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Team Tasks Section -->
                    <section id="team-tasks" class="content-section">
                        <h2 class="text-3xl font-bold mb-6 text-heading">Team-Specific Tasks & Tickets</h2>
                        
                        <!-- Design Team -->
                        <div class="mb-12">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3 text-heading"><i data-lucide="figma" class="w-6 h-6" style="color: var(--brand-green)"></i>Design Team</h3>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">UI Mockups for New Invoice Fields</h4>
                                    <p class="mt-2 flex-grow task-description">Create high-fidelity mockups for the invoice creation form, incorporating new fields like `ProveedorSistemas`, `CodigoActividadReceptor`, `TipoTransaccion`, and `NumeroVINoSerie`. Ensure the UI remains intuitive.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">Design UX for "Detalle Surtido" (Bundled Products)</h4>
                                    <p class="mt-2 flex-grow task-description">Design an intuitive user flow for adding and managing bundled products (`DetalleSurtido`). This should likely involve a modal or an expandable sub-form within a line item to detail the components of a package/combo.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Backend Team -->
                        <div class="mb-12">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3 text-heading"><i data-lucide="server-cog" class="w-6 h-6" style="color: var(--brand-blue)"></i>Backend Team</h3>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[BE] Update Header Data Models & Logic</h4>
                                    <p class="mt-2 flex-grow task-description">Update TypeScript interfaces for the invoice header. Add `proveedorSistemas`, `codigoActividadReceptor`. Modify `TipoIdentificacion` enum and expand `Numero` field to 20 chars. Remove `Fax` node. Update validation logic accordingly.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[BE] Implement Line Item Models & Logic</h4>
                                    <p class="mt-2 flex-grow task-description">Implement the new `DetalleSurtido` node and its sub-items. Add `TipoTransaccion` and `NumeroVINoSerie`. Update the `Descuento` model to include `CodigoDescuento`. Refactor `Impuesto` model for `BaseImponible`, `IVAcobradoFabrica`, and `DatosImpuestoEspecifico`.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[BE] Refactor Summary & Reference Logic</h4>
                                    <p class="mt-2 flex-grow task-description">Move the `MedioDePago` node to the Summary section and update its enum. Add new total fields (`TotalServNoSujetos`, etc.) and their calculation logic. Update `InformacionReferencia` enums to include new codes from Note 9 and 10.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Frontend Team -->
                        <div class="mb-12">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3 text-heading"><i data-lucide="smartphone-cog" class="w-6 h-6" style="color: var(--primary-color)"></i>Frontend Team</h3>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                               <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[FE] Implement UI for Header Changes</h4>
                                    <p class="mt-2 flex-grow task-description">Update the Flutter UI to include new fields: `ProveedorSistemas` (in settings), `CodigoActividadReceptor`. Update the `TipoIdentificacion` dropdown and expand the `Numero` field's max length. Remove the `Fax` field from all forms.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[FE] Build UI for Line Item Changes</h4>
                                    <p class="mt-2 flex-grow task-description">Implement UI for new line item fields: `TipoTransaccion`, `NumeroVINoSerie`. Add a dropdown for `CodigoDescuento`. Redesign the tax input section to accommodate new fields and logic. This includes the complex UI for `DetalleSurtido`.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">[FE] Update Summary and Reference UI</h4>
                                    <p class="mt-2 flex-grow task-description">Update the invoice summary view to display the new total fields (`TotalServNoSujetos`, etc.). Update the `MedioDePago` dropdown with new options. Ensure the UI for adding document references includes the new reference types.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                            </div>
                        </div>

                         <!-- Marketing Team -->
                        <div class="mb-12">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3 text-heading"><i data-lucide="megaphone" class="w-6 h-6" style="color: var(--brand-green)"></i>Marketing Team</h3>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">Prepare User Communication Strategy</h4>
                                    <p class="mt-2 flex-grow task-description">Develop a communication plan to inform existing users about the upcoming changes. This should include email announcements, in-app notifications, and a blog post explaining the benefits and new features.</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                                <div class="bg-section p-6 rounded-lg shadow-sm border border-main flex flex-col">
                                    <h4 class="font-bold text-lg text-heading task-title">Update Help Documentation and Tutorials</h4>
                                    <p class="mt-2 flex-grow task-description">Review and update all user-facing documentation, FAQs, and video tutorials to reflect the new v4.4 features and UI changes. Pay special attention to complex new features like "Detalle Surtido".</p>
                                    <button class="copy-btn mt-4 self-start text-sm font-medium py-2 px-4 rounded-full flex items-center gap-2" style="background-color: var(--primary-color); color: white;"><i data-lucide="copy" class="w-4 h-4"></i>Copy for Issue</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    <script>
        lucide.createIcons();

        // --- THEME SWITCHER LOGIC ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const html = document.documentElement;

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        };
        
        const setActiveButton = (theme) => {
             themeSwitcher.querySelectorAll('button').forEach(btn => {
                btn.style.color = 'var(--text-light)';
                btn.style.backgroundColor = 'transparent';
            });
            const activeButton = themeSwitcher.querySelector(`button[data-theme="${theme}"]`);
            if(activeButton) {
                activeButton.style.color = 'white';
                activeButton.style.backgroundColor = 'var(--primary-color)';
            }
        }

        const getSystemTheme = () => window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

        const handleThemeSelection = (selectedTheme) => {
            let themeToApply;
            if (selectedTheme === 'system') {
                localStorage.removeItem('theme');
                themeToApply = getSystemTheme();
            } else {
                localStorage.setItem('theme', selectedTheme);
                themeToApply = selectedTheme;
            }
            applyTheme(themeToApply);
            setActiveButton(selectedTheme);
        };

        themeSwitcher.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                handleThemeSelection(button.dataset.theme);
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'system';
        handleThemeSelection(savedTheme);
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                 handleThemeSelection('system');
            }
        });

        // --- COPY TO CLIPBOARD LOGIC ---
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', () => {
                const card = button.closest('.bg-section');
                const title = card.querySelector('.task-title').textContent.trim();
                const description = card.querySelector('.task-description').textContent.trim();
                
                const issueText = `### ${title}\n\n**Description:**\n${description}`;
                
                const textarea = document.createElement('textarea');
                textarea.value = issueText;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Copied!';
                    lucide.createIcons();
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        lucide.createIcons();
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textarea);
            });
        });

    </script>
</body>
</html>
